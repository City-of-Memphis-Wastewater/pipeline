#!/usr/bin/env python3
"""
build_release.py — Unified, clean, and reliable build script for pipeline-eds

Features:
- Builds wheel (Poetry or python -m build)
- Creates .pyz (zipapp), .pex, and .pyz (shiv) — all from a single clean source
- Zero .pyc files (guaranteed)
- Auto-generates Windows .bat and macOS .app wrappers
- Stamps version, git hash, and build time
- Supports extras: --windows, --mpl, --zoneinfo
- Works on Termux, Linux, macOS, Windows

Usage:
    python build_release.py
        python build_release.py --shiv
            python build_release.py --windows
            """

            import argparse
            import datetime
            import os
            import platform
            import shutil
            import subprocess
            import sys
            import tempfile
            import zipfile
            from pathlib import Path
            import re
            import toml

            # Optional: better OS detection
            try:
                import distro
                except ImportError:
                    distro = None

                    # ----------------------------------------------------------------------
                    # GLOBAL: Prevent .pyc files from ever being written
                    # ----------------------------------------------------------------------
                    os.environ["PYTHONDONTWRITEBYTECODE"] = "1"

                    # ----------------------------------------------------------------------
                    # Configuration
                    # ----------------------------------------------------------------------
                    ENTRY_POINT = "pipeline.cli:app"
                    DIST_DIR = Path("dist")

                    # ----------------------------------------------------------------------
                    # System Info
                    # ----------------------------------------------------------------------
                    class SystemInfo:
                        def __init__(self):
                                self.system = platform.system()
                                        self.arch = platform.machine().lower()

                                            def is_termux(self):
                                                    return "ANDROID_ROOT" in os.environ or "TERMUX_VERSION" in os.environ

                                                        def is_alpine(self):
                                                                return Path("/etc/alpine-release").exists()

                                                                    def get_os_tag(self):
                                                                            if self.system == "Windows":
                                                                                        ver = platform.win32_ver()[1]
                                                                                                    build = int(ver.split(".")[-1]) if "." in ver else 0
                                                                                                                return "windows11" if build >= 22000 else "windows10"
                                                                                                                        if self.system == "Darwin":
                                                                                                                                    return f"macos{platform.mac_ver()[0].split('.')[0]}"
                                                                                                                                            if self.system == "Linux":
                                                                                                                                                        if self.is_termux():
                                                                                                                                                                        return "android"
                                                                                                                                                                                    info = self._linux_distro()
                                                                                                                                                                                                ver = (info.get("version") or "").replace(".", "")
                                                                                                                                                                                                            return f"{info['id']}{ver}" if ver else info['id']
                                                                                                                                                                                                                    return self.system.lower()

                                                                                                                                                                                                                        def get_arch(self):
                                                                                                                                                                                                                                return "x86_64" if self.arch in ("amd64", "x86_64") else self.arch

                                                                                                                                                                                                                                    def _linux_distro(self):
                                                                                                                                                                                                                                            if distro:
                                                                                                                                                                                                                                                        return {"id": distro.id(), "version": distro.version()}
                                                                                                                                                                                                                                                                info = {}
                                                                                                                                                                                                                                                                        path = Path("/etc/os-release")
                                                                                                                                                                                                                                                                                if path.exists():
                                                                                                                                                                                                                                                                                            for line in path.read_text().splitlines():
                                                                                                                                                                                                                                                                                                            if "=" in line:
                                                                                                                                                                                                                                                                                                                                k, v = line.split("=", 1)
                                                                                                                                                                                                                                                                                                                                                    info[k.strip()] = v.strip().strip('"')
                                                                                                                                                                                                                                                                                                                                                            return {"id": info.get("ID", "linux"), "version": info.get("VERSION_ID", "")}

                                                                                                                                                                                                                                                                                                                                                            # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                            # Helpers
                                                                                                                                                                                                                                                                                                                                                            # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                            def run_command(cmd, cwd=None, check=True):
                                                                                                                                                                                                                                                                                                                                                                print(f"Running: {' '.join(map(str, cmd))}")
                                                                                                                                                                                                                                                                                                                                                                    result = subprocess.run(cmd, cwd=cwd, text=True, capture_output=True)
                                                                                                                                                                                                                                                                                                                                                                        if result.stdout:
                                                                                                                                                                                                                                                                                                                                                                                print(result.stdout)
                                                                                                                                                                                                                                                                                                                                                                                    if result.stderr:
                                                                                                                                                                                                                                                                                                                                                                                            print(result.stderr, file=sys.stderr)
                                                                                                                                                                                                                                                                                                                                                                                                if check and result.returncode != 0:
                                                                                                                                                                                                                                                                                                                                                                                                        raise subprocess.CalledProcessError(result.returncode, cmd)
                                                                                                                                                                                                                                                                                                                                                                                                            return result

                                                                                                                                                                                                                                                                                                                                                                                                            def clean_dir(path: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                if path.exists():
                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Cleaning {path}...")
                                                                                                                                                                                                                                                                                                                                                                                                                                shutil.rmtree(path, ignore_errors=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                def remove_pyc(root: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                    if not root.exists():
                                                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                                                                for f in root.rglob("*.pyc"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                        f.unlink()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"  Removed {f}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for d in root.rglob("__pycache__"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            shutil.rmtree(d, ignore_errors=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"  Removed {d}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Wheel & Metadata
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def build_wheel(dist_dir: Path) -> Path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dist_dir.mkdir(exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            clean_dir(dist_dir)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if shutil.which("poetry"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("Building wheel with Poetry...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_command(["poetry", "build", "-f", "wheel"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Building wheel with python -m build...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run_command([sys.executable, "-m", "build", "--wheel"])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        wheels = list(dist_dir.glob("*.whl"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not wheels:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    raise FileNotFoundError("No wheel built")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        latest = max(wheels, key=lambda p: p.stat().st_mtime)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"Built: {latest.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return latest

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def extract_metadata(wheel: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with zipfile.ZipFile(wheel) as z:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            meta = [f for f in z.namelist() if f.endswith(".dist-info/METADATA")]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not meta:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                raise ValueError("No METADATA in wheel")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        content = z.read(meta[0]).decode()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name = re.search(r"^Name: (.+)", content, re.M).group(1).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ver = re.search(r"^Version: (.+)", content, re.M).group(1).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return name, ver

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def get_py_tag():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return f"py{sys.version_info.major}{sys.version_info.minor}"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extract & Clean Once
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def extract_and_clean(wheel: Path) -> Path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tmp = Path(tempfile.mkdtemp(prefix="pipeline_build_"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"Extracting wheel to {tmp}...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                with zipfile.ZipFile(wheel) as z:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        z.extractall(tmp)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Removing any stray .pyc files...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                remove_pyc(tmp)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return tmp

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Builders
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ----------------------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def build_zipapp(src_dir: Path, out_path: Path, entry: str):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Building zipapp → {out_path.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            pkg, fn = entry.rsplit(":", 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
