#!/usr/bin/env python3
"""
build_release.py – Unified release builder for pipeline-eds

Features:
- Builds wheel (Poetry or python -m build)
- Creates:
    • .pyz via zipapp (default) – pure-Python, universal, no .pyc
        • .pyz via shiv (optional) – full venv, C-extensions
            • .pex (PEX) – Linux/macOS only (fails on Termux)
            - Stamps _version.py (in package + dist/)
            - Generates Windows .bat, macOS .app
            - Supports extras, OS/arch tagging
            - --skip-build-wheel, --shiv, --no-pyc
            """

            import argparse
            import datetime
            import os
            import platform
            import shutil
            import subprocess
            import sys
            import tempfile
            import zipfile
            from pathlib import Path
            import re
            import toml

            # Optional: better Linux detection
            try:
                import distro
                except ImportError:
                    distro = None


                    # -----------------------------
                    # Configuration
                    # -----------------------------
                    PROJECT_ROOT = Path(__file__).parent
                    DIST Dir = PROJECT_ROOT / "dist"
                    ENTRY_POINT = "pipeline.cli:app"
                    PYTHON_BIN = sys.executable


                    # -----------------------------
                    # System Info
                    # -----------------------------
                    class SystemInfo:
                        def __init__(self):
                                self.system = platform.system()
                                        self.arch = platform.machine().lower()
                                                self.arch = "x86_64" if self.arch in ("amd64", "x86_64") else self.arch

                                                    def is_termux(self):
                                                            return "ANDROID_ROOT" in os.environ or "TERMUX_VERSION" in os.environ

                                                                def get_os_tag(self):
                                                                        if self.system == "Windows":
                                                                                    build = platform.win32_ver()[1].split(".")[-1]
                                                                                                return "windows11" if int(build or 0) >= 22000 else "windows10"
                                                                                                        if self.system == "Darwin":
                                                                                                                    return f"macos{platform.mac_ver()[0].split('.')[0] or 'unknown'}"
                                                                                                                            if self.system == "Linux":
                                                                                                                                        if self.is_termux():
                                                                                                                                                        return "android"
                                                                                                                                                                    info = self._linux_distro()
                                                                                                                                                                                ver = (info.get("version") or "").split(".")[0]
                                                                                                                                                                                            return f"{info['id']}{ver}" if ver else info['id']
                                                                                                                                                                                                    return self.system.lower()

                                                                                                                                                                                                        def _linux_distro(self):
                                                                                                                                                                                                                if distro:
                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                            "id": distro.id(),
                                                                                                                                                                                                                                                            "version": distro.version(),
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                            with open("/etc/os-release") as f:
                                                                                                                                                                                                                                                                                                            data = {}
                                                                                                                                                                                                                                                                                                                            for line in f:
                                                                                                                                                                                                                                                                                                                                                if "=" in line:
                                                                                                                                                                                                                                                                                                                                                                        k, v = line.strip().split("=", 1)
                                                                                                                                                                                                                                                                                                                                                                                                data[k] = v.strip('"')
                                                                                                                                                                                                                                                                                                                                                                                                                return {"id": data.get("ID", "linux"), "version": data.get("VERSION_ID", "")}
                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                                                                                                                                                                                                                                                    return {"id": "linux", "version": ""}


                                                                                                                                                                                                                                                                                                                                                                                                                                    # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                    # Helpers
                                                                                                                                                                                                                                                                                                                                                                                                                                    # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                    def run_command(cmd, cwd=None, check=True):
                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"RUN: {' '.join(map(str, cmd))}")
                                                                                                                                                                                                                                                                                                                                                                                                                                            result = subprocess.run(cmd, cwd=cwd, text=True, capture_output=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                if result.stdout:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(result.stdout)
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if result.stderr:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(result.stderr, file=sys.stderr)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if check and result.returncode != 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                raise subprocess.CalledProcessError(result.returncode, cmd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return result


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def get_version():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = toml.load(PROJECT_ROOT / "pyproject.toml")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return data["tool"]["poetry"]["version"]


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def get_package_name():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                data = toml.load(PROJECT_ROOT / "pyproject.toml")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return data["tool"]["poetry"]["name"]


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def get_python_tag():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return f"py{sys.version_info.major}{sys.version_info.minor}"


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def dynamic_name(name, ver, py, os_tag, arch, extras=""):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            extras_part = f"-{extras}" if extras else ""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return f"{name}-{ver}-{py}-{os_tag}-{arch}{extras_part}"


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Wheel
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def build_wheel(dist_dir: Path, use_poetry: bool = True) -> Path:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dist_dir.mkdir(exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("Building wheel...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if use_poetry and shutil.which("poetry"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run_command(["poetry", "build", "--format", "wheel"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_command([sys.executable, "-m", "build", "--wheel", "--outdir", str(dist_dir)])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wheels = list(dist_dir.glob("*.whl"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not wheels:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                raise FileNotFoundError("No wheel built")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return max(wheels, key=lambda p: p.stat().st_mtime)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def find_wheel(dist_dir: Path) -> Path | None:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        wheels = list(dist_dir.glob("*.whl"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return max(wheels, key=lambda p: p.stat().st_mtime) if wheels else None


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Version Stamping
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def stamp_version(dist_dir: Path, pkg_dir: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                version = get_version()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    git_hash = subprocess.getoutput("git rev-parse --short HEAD") or "unknown"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timestamp = datetime.datetime.utcnow().isoformat(timespec="microseconds")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            content = f'''\
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Auto-generated version file – DO NOT EDIT
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            __version__ = "{version}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            __git__ = "{git_hash}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            __build_time__ = "{timestamp}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '''

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # 1. Inside package (gets bundled in wheel)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (pkg_dir / "_version.py").write_text(content)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # 2. In dist/ for release
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (dist_dir / "_version.py").write_text(content)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Stamped _version.py → {pkg_dir.name}/_version.py & dist/")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # zipapp Builder (Recommended)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def build_zipapp(wheel: Path, output: Path, entry: str, no_pyc: bool = True):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"\nBuilding zipapp → {output.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with tempfile.TemporaryDirectory() as tmp:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tmp_path = Path(tmp)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with zipfile.ZipFile(wheel) as z:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    z.extractall(tmp_path)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Create __main__.py
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main_py = f'''\
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    #!/usr/bin/env python3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    from {entry.rsplit(':', 1)[0]} import {entry.rsplit(':', 1)[1]}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        import sys
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sys.exit({entry.rsplit(':', 1)[1]}())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            '''
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (tmp_path / "__main__.py").write_text(main_py)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cmd = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sys.executable, "-m", "zipapp",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    str(tmp_path),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "-p", "/usr/bin/env python3",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "-o", str(output),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if no_pyc:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cmd.append("--no-pyc")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cmd.extend(["-c"])  # compress

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run_command(cmd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                output.chmod(0o755)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("zipapp built – pure .py, no .pyc, universal")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # shiv Builder (Optional)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def build_shiv(wheel: Path, output: Path, entry: str):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"\nBuilding shiv → {output.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            venv = os.environ.get("VIRTUAL_ENV")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not venv:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        raise RuntimeError("VIRTUAL_ENV not set")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            site_pkg = Path(venv) / "lib" / f"python{sys.version_info.major}.{sys.version_info.minor}" / "site-packages"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cmd = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "shiv",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "--site-packages", str(site_pkg),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "--entry-point", entry,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "--output-file", str(output),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "--python-shebang", "/usr/bin/env python3",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "--no-cache",  # no .pyc
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        str(wheel),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run_command(cmd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    output.chmod(0o755)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("shiv built – full venv, no .pyc")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # PEX Builder
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def build_pex(wheel: Path, output: Path, entry: str):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"\nBuilding PEX → {output.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cmd = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sys.executable, "-m", "pex",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                str(wheel),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "--output-file", str(output),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "--entry-point", entry,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "--python", "python3",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "--python-shebang", "/usr/bin/env python3",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run_command(cmd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("PEX built")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Launchers
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def make_bat(pyz: Path, bat: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bat.write_text(f'''@echo off\npython "%~dp0{pyz.name}" %*\n''')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"Windows .bat → {bat}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def make_macos_app(pyz: Path, app_dir: Path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        app_dir.mkdir(parents=True, exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            macos = app_dir / "Contents" / "MacOS"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                macos.mkdir(parents=True, exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    exec_path = macos / pyz.name
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        shutil.copy2(pyz, exec_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            exec_path.chmod(0o755)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"macOS .app → {app_dir}")


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Main
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    parser = argparse.ArgumentParser(description="pipeline-eds release builder")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        parser.add_argument("--skip-build-wheel", action="store_true")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            parser.add_argument("--shiv", action="store_true", help="Use shiv instead of zipapp")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                parser.add_argument("--no-pyc", action="store_true", default=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    parser.add_argument("--windows", action="store_true")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        parser.add_argument("--mpl", action="store_true")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            parser.add_argument("--zoneinfo", action="store_true")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                parser.add_argument("--entry-point", default=ENTRY_POINT)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    args = parser.parse_args()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        extras = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if args.windows: extras.append("windows")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if args.mpl: extras.append("mpl")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if args.zoneinfo: extras.append("zoneinfo")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        extras_str = "-".join(extras) if extras else ""

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DIST_DIR.mkdir(exist_ok=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- Wheel ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wheel = find_wheel(DIST_DIR)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if args.skip_build_wheel and wheel:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Using existing wheel: {wheel.name}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DIST_DIR.mkdir(exist_ok=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for f in DIST_DIR.iterdir():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if f.is_file(): f.unlink()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else: shutil.rmtree(f)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    wheel = build_wheel(DIST_DIR, use_poetry=shutil.which("poetry"))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- Extract info ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            name, ver = get_package_name(), get_version()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                py_tag = get_python_tag()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sysinfo = SystemInfo()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        os_tag = sysinfo.get_os_tag()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            arch = sysinfo.get_arch()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # --- Version stamp ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pkg_dir = PROJECT_ROOT / "src" / "pipeline"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stamp_version(DIST_DIR, pkg_dir)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # --- Build binaries ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                base_name = dynamic_name(name, ver, py_tag, os_tag, arch, extras_str)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # zipapp (default)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        zipapp_path = DIST_DIR / f"{base_name}.pyz"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if args.shiv:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    shiv_path = DIST_DIR / f"{base_name}-shiv.pyz"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            build_shiv(wheel, shiv_path, args.entry_point)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        build_zipapp(wheel, zipapp_path, args.entry_point, no_pyc=args.no_pyc)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
